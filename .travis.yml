jobs:
  include:
    - stage: bundle audit && test
      language: ruby
      rvm: 2.4
      env:
        - RACK_ENV=test
      services:
        - mysql
      before_install:
        - openssl aes-256-cbc -K $encrypted_dee5a0b392fa_key -iv $encrypted_dee5a0b392fa_iv -in config/configs.tar.enc -out config/configs.tar -d
        - tar xvf config/configs.tar
      script:
        - bundle exec bundle-audit update && bundle exec bundle-audit check
        - bundle exec rake db:create
        - bundle exec rake db:migrate
        - bundle exec rspec
        - bundle exec rake coveralls:push
    - stage: staging
      language: minimal
      before_deploy:
        - openssl aes-256-cbc -K $encrypted_dee5a0b392fa_key -iv $encrypted_dee5a0b392fa_iv -in config/configs.tar.enc -out config/configs.tar -d
        - tar xvf config/configs.tar
        - git add -f config/app.yml
        - git add -f config/database.yml
        - git commit -m "Adds config files"
      deploy:
        provider: heroku
        app: sinatraapi-staging
        api_key:
          secure: "iJ9yjc5DYksAQh65hexGOZhFz5yXuLGGpfBVUeefl4cHmHUAFln3TMa6c4uP5ZHnf/hLw4DcGqhknE954w5bCNbOAFkrZiElF0QD5he3AwxI60Yd2ZZSJjQPj61rjlfLlbwbRLSOn2pdouokaPpZbA5jH+D9Lxy0Q302OhN6ZXhsYVMQ/5De3FTOoGSyyEsSYOl64wekYAktQFrBGwlXLtRc6WVdQ0QIvFM2ai43mL1EzfBeJZmOzq9h5wB2z2sDwVOJBMRNiv6Q/1Uk/fGHznoKxRDlJ/Xe0hoGSnuWp7JjYohOxkyOOhIRwSrFGbZ5V+F0EKgfq0s4V2KvxShILd+tSJK4w7fRCYp/UUj0kuc7FYZhmfrQETXtAh5QBSRN7tOOe3lxv4QRu3mCH0I9Un6ldJJadXwTZfOEwlCWy9qIdw/ZXc4OGA8ijEzSqcNhFQc1j4kpjOGd2NgnkHim8d1+4Zs5iXi5bdozL6mJFVBhUM2fdrAWfnU3H6nyb/DCvAm77d5lw5uKd/muIfPgWYsEOjObZct/2tCu25w7C+5aH+IO9fksq/1yQQ5/EZK4g0vh88CCCVKKnsrYQWr88ZtkF6/hPPGlk2O4Q7qnwqFcz5gcSpUjHdf5CWxdybg2YpaNDr8Gmdnv2pHDQ8Eo6KyPOeR8wlKK0ZaCgb4OjFo="
        run:
          - "bundle exec rake db:migrate"
          - "bundle exec rake db:seed"
    - stage: smoke staging
      language: ruby
      rvm: 2.4
      script: ruby smoke_test/script.rb https://sinatraapi-staging.herokuapp.com
    - stage: production
      language: minimal
      before_deploy:
        - openssl aes-256-cbc -K $encrypted_dee5a0b392fa_key -iv $encrypted_dee5a0b392fa_iv -in config/configs.tar.enc -out config/configs.tar -d
        - tar xvf config/configs.tar
        - git add -f config/app.yml
        - git add -f config/database.yml
        - git commit -m "Adds config files"
      deploy:
        provider: heroku
        app: sinatraapi
        api_key:
          secure: "iJ9yjc5DYksAQh65hexGOZhFz5yXuLGGpfBVUeefl4cHmHUAFln3TMa6c4uP5ZHnf/hLw4DcGqhknE954w5bCNbOAFkrZiElF0QD5he3AwxI60Yd2ZZSJjQPj61rjlfLlbwbRLSOn2pdouokaPpZbA5jH+D9Lxy0Q302OhN6ZXhsYVMQ/5De3FTOoGSyyEsSYOl64wekYAktQFrBGwlXLtRc6WVdQ0QIvFM2ai43mL1EzfBeJZmOzq9h5wB2z2sDwVOJBMRNiv6Q/1Uk/fGHznoKxRDlJ/Xe0hoGSnuWp7JjYohOxkyOOhIRwSrFGbZ5V+F0EKgfq0s4V2KvxShILd+tSJK4w7fRCYp/UUj0kuc7FYZhmfrQETXtAh5QBSRN7tOOe3lxv4QRu3mCH0I9Un6ldJJadXwTZfOEwlCWy9qIdw/ZXc4OGA8ijEzSqcNhFQc1j4kpjOGd2NgnkHim8d1+4Zs5iXi5bdozL6mJFVBhUM2fdrAWfnU3H6nyb/DCvAm77d5lw5uKd/muIfPgWYsEOjObZct/2tCu25w7C+5aH+IO9fksq/1yQQ5/EZK4g0vh88CCCVKKnsrYQWr88ZtkF6/hPPGlk2O4Q7qnwqFcz5gcSpUjHdf5CWxdybg2YpaNDr8Gmdnv2pHDQ8Eo6KyPOeR8wlKK0ZaCgb4OjFo="
        run:
          - "bundle exec rake db:migrate"
          - "bundle exec rake db:seed"
    - stage: smoke production
      language: ruby
      rvm: 2.4
      script: ruby smoke_test/script.rb https://sinatraapi.herokuapp.com